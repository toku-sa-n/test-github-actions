name: CI

on:
  push:
    branches:
      - master

  pull_request:
    branches:
      - master

jobs:
  test:
    runs-on: "windows-latest"

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Find gmp.h on powershell
        run: find / -name gmp.h
        shell: pwsh

      - name: Setup msys2
        uses: msys2/setup-msys2@v2
        with:
          install: |
            git
            mingw-w64-x86_64-gmp

      # See https://github.com/ocaml-opam/opam-repository-mingw#updates for `opam-repositories`.
      - name: Install OCaml
        uses: ocaml/setup-ocaml@v2.2.8
        with:
          ocaml-compiler: "4.14.1"
          opam-repositories: |
            opam-repository-mingw: https://github.com/ocaml-opam/opam-repository-mingw.git#sunset
            default: https://github.com/ocaml/opam-repository.git
          dune-cache: true

      - name: Clone
        run: git clone https://github.com/toku-sa-n/coqfmt.git

      - name: Check PATH
        run: echo $PATH

      - name: env
        run: opam env
        shell: pwsh

      - name: Find opam
        run: find / -name opam

      - name: Install dependencies
        run: cd coqfmt && opam install --deps-only --with-test .
